# 第3章 运输层

## 3.1 概述运输层服务

运输层协议是在端系统中实现的，而不是在路由器中实现，在发送端，运输层将从发送应用程序接收到的报文转换成运输层分组，也称为运输层报文段。

网络层提供主机之间的逻辑通信，运输层为运行在不同主机上的进程之间提供了逻辑通信。

## 3.2 多路复用与多路分解

将运输层报文段中的数据交付到正确的套接字的工作称为**多路分解**。

在源主机从不同套接字中收集数据块，并为每个数据块上封装上首部信息（这将在以后用于分解）从而生成报文段，然后将这些报文报传递到网络层，所有这些工作称为**多路复用**。

运输层报文段中的源于目的端口字段：

![Snipaste_2019-08-18_11-15-27.jpg](https://i.loli.net/2019/08/18/pdt58S1Ki3kaRlm.jpg)

运输层实现分解服务的过程：在主机上的每个套接字能够分配一个端口号，当报文到达主机时，运输层检查报文中的目的端口号，并将其定向到相应的套接字。然后报文段中的数据通过套接字进入其所连接的进程。

## 3.3 无连接运输：UDP

**1.UDP报文结构**

应用层数据占用UDP报文段的数据字段。

![Snipaste_2019-08-18_14-48-01.jpg](https://i.loli.net/2019/08/18/odNwqkuz8GetbrI.jpg)

UDP首部只有4个字段，每个字段由两个字节组成。通过端口号可以是目的主机将应用数据交给运行在目的端系统中的相应进程。长度字段只是了在UDP报文段中的字节数（首部加数据）。接收方通过校验和来检查在该报文段中是否出现了差错。

**UDP校验和**

UDP校验和提供了差错检测功能。校验和用于确定当UDP报文段从源到达目的地移动时，其中的比特是否发生了改变。

## 3.4 可靠数据传输原理

## 3.5 面向连接的运输：TCP

TCP被称为面向连接的，因为在一个应用进程可以开始向另一个应用应用进程发送数据之前，这两个进程必须先相互“握手”，即他们必须相互发送某些预备报文段，以建立确保数据传输的参数。作为TCP连接建立的一部分，连接的双发相互发送某些预备报文段，以建立确保数据传输的参数。

TCP协议只在端系统中运行。

TCP连接提供的是全双工服务：如果一台主机上的进程A与另一台主机上的进程B存在一条TCP连接，那么应用层数据就可在从进程B流向进程A的同时，也从进程A流向进程B。

TCP经过握手建立连接后，发送数据的过程

![Snipaste_2019-08-18_15-40-25.jpg](https://i.loli.net/2019/08/18/Gv528rq9dK4AMWL.jpg)
TCP连接的每一端都有各自的发送缓存和接受缓存。

TCP 连接的组成包括：一台主机上的缓存、变量和与进程连接的套接字，以及另一台主机上的另一组缓存、变量和与进程连接的套接字。

**TCP报文段结构**

TCP报文段由首部字段和一个数据字段组成。具体组成如下：

![Snipaste_2019-08-18_15-50-49.jpg](https://i.loli.net/2019/08/18/tKZs32rhWJDFBdb.jpg)



* 首部包括源端口号和目的端口号 (被用于多路复用/分解来自或送到应用的数据) 。

* 32比特的序号字段和32比特的确认号字段。为TCP发送方和接收方用来实现可靠数据传输服务。

* 16比特的接收窗口字段，该字段用于流量控制。

* 4比特的首部长度字段，该字段指示以32比特的字为单位的TCP首部长度。

* 可选与变长的选项字段。

* 6比特的标志位。

  **ACK**：用于指示确认字段中的值是有效的，即该报文包括一个对已被成功接收报文段的确认。

  **RST、SYN和FIN**：用于建立和拆除

  **PSH**：被设置的时候，指示接收方应立即将数据交给上层。

  **URG**：用于指示报文里存在着被发送端的上层实体设置为"紧急"的数据。

**TCP的可靠数据传输**：确保一个进程从其接收缓存中读出的数据流是无损坏、无间隔、非冗余和按序的数据流。

### TCP 可靠传输
TCP 使用超时重传来实现可靠传输：如果一个已经发送的报文段在超时时间内没有收到确认，那么就重传这个报文段。

### TCP 滑动窗口


###  TCP 拥塞控制

如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，从而导致网络拥塞程度更高。因此当出现拥塞时，应当控制发送方的速率。这一点和流量控制很像，但是出发点不同。流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度。


### TCP流量控制
TCP 流量控制服务以消除接收方缓存移除的可能性。
接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。





