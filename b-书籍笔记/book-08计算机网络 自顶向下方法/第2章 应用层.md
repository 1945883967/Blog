# 第2章 应用层

## 2.1 应用层协议原理

应用程序体系结构有应用程序研发者设计，现代网络主流的体系结构之一：

* 客户-服务器体系结构
* 对等（P2P）体系结构

**客户-服务器体系结构**：有一个总是打开的主机称为服务器，它服务于来自许多其他称为客户机的主机请求。

**P2P体系结构**：对位于数据中心的专用服务器有最小（或者没有）依赖。相反，应用程序在间断连接的主机之间使用使用直接通信，这些主机被称为对等方。

**进程通信**

当进程运行在相同的端系统上时，他们使用进程间通信机制相互通信。进程间通信的规则由端系统上的操作系统确定。在两个不同端系统上的进程，通过跨越计算机网路交换报文而相互通信。

进程通过一个称为**套接字(socket)**的软件接口向网络发送报文和从网络接收报文。套接字是同一台主机内应用层与运输层之间的接口。该套接字是建立网络应用程序的可编程接口，因此套接字也称为应用程序和网络之间的**应用程序编程接口**。

![Snipaste_2019-08-17_14-00-05.jpg](https://i.loli.net/2019/08/17/AMkG1xFnuPI7gYt.jpg)

因特网（更一般的是TCP/IP网络）为应用程序提供两个运输层协议，即UDP和TCP。为因特网创建一个新的应用程序时，首先要做出的决定是，选择UDP还是选择TCP。

### TCP服务

**TCP**服务模型包括**面向连接服务**和**可靠数据传输服务**。

* 面向连接到服务

  在应用层数据报文开始流动之前，TCP让客户和服务器通过握手建立一条两个进程套接字之间的TCP连接。这条连接是全双工的，即连接双方的进程可以在此链接上同时进行报文收发。当应用程序结束报文发送时，必须拆除该连接。

* 可靠数据传输服务

  通信进程通过TCP，能无差错、按适当顺序交付所有发送的数据。并且没有字节丢失和冗余。TCP协议还具有拥塞控制机制，当发送方和接收方之间的网络出现拥塞时，TCP的拥塞控制机制会抑制发送进程。

### UDP 服务

UDP是一种不提供不必要服务的轻量级运输协议，它仅提供最小服务。UDP是无连接的，因此在两个进程通信前没有握手过程。UDP协议提供一种不可靠数据传输服务。当进程将一个报文发送进UDP套节字时，UDP协议并不保证该报文将到达接收进程。而且到达接收进程的报文可能是乱序到达的。UDP没有包括拥塞控制机制。

**流行的因特网应用及其应用层协议和支撑的运输协议**

![Snipaste_2019-08-17_14-46-06.jpg](https://i.loli.net/2019/08/17/STvbgCxXfZIl6Wp.jpg)

## 2.2 Web和HTTP

Web应用层协议是超文本传输协议，它是Web的核心。HTTP由两个程序实现：一个客户程序和一个服务程序。客户程序和服务程序运行在不同的端系统上，通过交换HTTP报文进行会话。HTTP定义了这些报文的结构和服务器进行报文交换的方式。（Web浏览器实现了HTTP客户端），主流的Web服务器Apache 。。。

HTTP使用TCP作为它的支撑运输协议（而不是在UDP上运行）。

注意：服务器向客户发送被请求的文件，而不存储任何关于该客户的状态信息。假如某个特定的客户在短短的几秒内两次请求同一个对象，服务器并不会因为刚刚为该客户提供了该对象就不再做出响应，而是重新发送该对象。因为HTTP服务器并不保存关于客户的任何信息，所以我们说HTTP是一个无状态协议。

### HTTP报文格式

**1.HTTP请求报文**

一个HTTP请求报文通用格式

![Snipaste_2019-08-17_16-08-17.jpg](https://i.loli.net/2019/08/17/rexCZXTAdy983iF.jpg)

使用GET方法时，实体主体为空。而使用POST时，才使用该实体。

**2.HTTP响应报文**

一个HTTP报文响应格式

![Snipaste_2019-08-17_16-14-35.jpg](https://i.loli.net/2019/08/17/7x13rKQUdpMlHIB.jpg)

* 状态行：协议版本字段、状态码和相应的状态信息。

* 首部行：

  Collection: close：告诉客户，发送完报文后将关闭该TCP连接。

  Data：指示服务器产生并发送相应报文的日期和时间

  Server：服务器类型

  Last-Modified：对象创建或者最后修改的时间

  Content-Length: 被发送数据对象中的字节数

  Content-Type: 指示实体体中的对象

* 实体体

一些常见的状态码和状态信息：

* 200  OK: 请求成功，信息在返回的响应报文中
* 301  Moved Permanently: 请求的对象已经被永久转移了，新的URL定义在响应报文Location: 首部行中。客户软件将自动获取新的URL。
* 400  Bad Request: 一个通用的错误代码，指示该请求不能被服务器理解。
* 404  Not found: 被请求的文档不再服务器上。
* 505  HTTP Version Not Supported: 服务器不支持请求报文使用的HTTP协议版本。

**cookie**

**Web 缓存,也叫代理服务器**

**条件GET方法**

## 2.3 文件传输协议：FTP

在一个FTP会话中，一台主机可以向另一台远程主机传输（或接受来自远程主机）的文件。为了使用户能访问它的远程账户，用户必须提供一个用户标识和口令。在提供了授权信息后，用户能从本地文件系统向远程主机文件系统传送文件，反之依然。

![Snipaste_2019-08-17_16-56-33.jpg](https://i.loli.net/2019/08/17/p4HOZuPUgjF9XCn.jpg)

当用户主机与远程主机开始一个FTP会话时，FTP的客户端首先在服务器 21 号端口与服务器端发起一个用于控制的TCP连接。FTP的客户端也通过该控制连接发送用户的标识和口令，发送改变远程目录的命令。当FTP的服务端从该连接上收到一个文件传输的命令后，就会发起一个到客户端的TCP数据连接。FTP在该连接上准确的发送一个文件，然后关闭该链接。在一个会话期间，如果用户还需要传输另一个文件，FTP则打开另一个数据连接。但对于FTP传输而言，控制连接则贯穿整个用户会话期间。但对会话中的每一次文件传输都需要建立一个新的数据连接（即数据连接是非持续的）。

## 2.5 DNS：因特网的目录结构

主机的标识方法有主机名(hostname)和IP地址(IP address)。

**域名系统(Domain Name System,DNS)**:主要任务是实现主机名到IP地址转换。

DNS是：

* 一个由分层的DNS服务器实现的分布式数据库；
* 一个使得主机能够查询分布式数据库的应用层协议。

DNS协议运行在UDP之上，使用53号端口。

DNS提供的一些重要服务：

* 主机别名
* 邮件服务器别名
* 负载分配

域名解析的过程：

先从在本地host文件查找是否有网址映射关系，如果有完成域名解析，如果没有在本地DNS服务器查找，如果有完成域名解析，如果没有本地DNS服务器找13台根DNS服务器，根DNS服务器找顶级域名DNS服务器，顶级域名DNS服务器找权威DNS域名解析器，然后把域名对象的地址向上返回到本地DNS服务器，完成解析。



