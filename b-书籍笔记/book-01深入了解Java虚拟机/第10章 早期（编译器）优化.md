# 第10章 早期（编译器）优化

## Javac编译器

javac由java代码编写

从Sun Javac的代码来看，编译过程大致可以分为3个过程：

* 解析与填充符号表的过程。
* 插入式注解处理器的注解处理过程。
* 分析与字节码生成过程。

这三个步骤之间的关系与交互顺序如图：

![Snipaste_2019-08-12_10-22-46.jpg](https://i.loli.net/2019/08/12/tyniqa3sGMpB1Yh.jpg)

### 解析与符号填充

**1.词法、语法分析**

**语法分析：**是将源代码的字符流转换为标记（Token）集合，单个字符是程序编写过程的最小元素，而标记则是编译过程的最小元素。

**语法分析**：根据Token序列构造抽象语法树的过程，抽象语法树是一种用来描述程序代码语法结构的树形表示方式，语法树的每一个节点都代表着程序到吗中的一个语法结构（例如包、类型、修饰符、运算符、接口、返回值甚至代码注释等都可以是一个语法结构）。

**2.填充符号表**

**符号表（Symbol Table)**:是一组符号地址和符号信息构成的表格。

## 注解处理器

### 语义分析与字节码生成

语法分析之后，编译器获得了程序代码的抽象语法树表示，语法树能表示一个结构正确的源程序的抽象，但无法保证源程序是符合逻辑的。而语义分析的主要任务是对结构上正确的源程序进行上下文有关性质的审查。

**1.标志检查**

标注检查的步骤包括诸如变量使用前是否已经声明、变量与赋值之间的数据类型是否能够完全匹配等。

在标注检查步骤中，还有一个重要的动作称为**常量折叠**，如果我们在代码中定义如下形式：

`int a = 1 + 2;`

那么语法树上任然能看到字面量“1”，“2”以及操作符“+”，但经过常量折叠后，它们被折叠为字面量“3”。

**2.数据及控制流分析**

数据及控制流分析是对程序上下文逻辑更进一步的验证，它可以检查出诸如程序局部变 量在使用前是否有赋值、方法的每条路径是否都有返回值、是否所有的受查异常都被正确处 理了等问题。编译时期的数据及控制流分析与类加载时的数据及控制流分析的目的基本上是 一致的，但校验范围有所区别，有一些校验项只有在编译期或运行期才能进行。

**3.解语法糖**

语法糖（Syntactic Sugar），也称糖衣语法，指在计算机语言中添加的某种语法，这种语法对语言的功能并没有影响，但是更方便程序员使用。通常来说，使用语法糖能够增加程序的可读性， 从而减少程序代码出错的机会。 

在编译阶段语法糖被还原回简单的基础语法结构，这个过程称为解语法糖。

**4.字节码生成**

字节码生成阶段不仅仅是把前面各个步骤所生成的信 息（语法树、符号表）转化成字节码写到磁盘中，编译器还进行了少量的代码添加和转换工作。 

## Java语法糖的味道

语法糖虽然 不会提供实质性的功能改进，但是它们或能提高效率，或能提升语法的严谨性，或能减少编码出错的机会。

### 1.泛型与类型擦除

泛型是JDK1.5的一项新特性，它的本质是参数化类型的应用，也就是说所操作的数据类型被指定为一个参数。这种参数类型可以用在类、接口和方法的创建中，分别称为泛型类、泛型接口和泛型方法。

### 2.自动装箱、拆箱与遍历循环

自动装箱拆箱中该注意的点：

```java
public class TestSugar {
	public static void main(String[] args) {
		Integer a = 1;
		Integer b = 2;
		Integer c = 3;
		Integer d = 3;
		Integer e = 321;
		Integer f = 321;
		Long g = 3L;
		System.out.println(c == d);
		System.out.println(e == f);
		System.out.println(c == (a + b));
		System.out.println(c.equals(a + b));
		System.out.println(g == (a + b));
		System.out.println(g.equals(a + b));
	}
}/**Output:
true
false
true
true
true
false
*/
```

应注意包装类型中的equals方法：(以Integer为例)

```java
public boolean equals(Object obj) {
        if (obj instanceof Integer) {
            return value == ((Integer)obj).intValue();
        }
        return false;
    }
```

### 3. 条件编译