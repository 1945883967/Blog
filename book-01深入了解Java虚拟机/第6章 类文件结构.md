#  第六章 类文件结构



代码编译的结果从本地机器码转变为字节码（Java的.class文件）。

计算机只认识0和1，所以我们写的程序需要经编译器翻译成0和1构成的二进制格式才能由计算机执行。但随着技术的发展，越来越多的程序设计语言选择了与操作系统和机器指令集无关的、平台中立的格式作为编译后的存储格式。

## 6.2无关性的基石

各种**不同的虚拟机**与**所有平台**都统一使用的程序存储格式---**字节码**（ByteCode)是构成平台无关性的基石。

实现**语言无关性**基石仍然是**虚拟机和字节码存储格式**。Java虚拟机不和包括Java在内的任何语言绑定，它只与**“Class文件"**这种特定的二进制文件格式所关联，Class文件包含了Java虚拟机**指令集**和**符号表**以及若干其他辅助信息。基于安全方面的考虑，Java虚拟机规 范要求在Class文件中使用许多强制性的语法和结构化约束，但任何一门功能性语言都可以表示为一个能被Java虚拟机所接受的有效的Class文件。

作为一个**通用的、机器无关**的**执行平台**， 任何其他语言的实现者都可以将Java虚拟机作为语言的产品交付媒介。例如，使用Java编译 器可以把Java代码编译为存储字节码的Class文件，使用JRuby等其他语言的编译器一样可以 把程序代码编译成Class文件，虚拟机并不关心Class的来源是何种语言，如图
![Snipaste_2019-04-02_11-47-53.jpg](https://i.loli.net/2019/04/02/5ca2db7e87ed4.jpg)

Java语言中的**各种变量、关键字和运算符号的语义**最终都是由**多条字节码命令组合而成**的，因此**字节码命令**所能提供的语义描述能力肯定会比Java语言本身更加强大。因此，**字节码本身**可以有效支持一 些Java语言本身无法有效支持的语言特性，这也为其他语言实现一些有别于Java的语言特性提供了基础。

**任何一个Class文件都对应着唯一一个类或接口的定义信息**，但反过来说，类或接 口并不一定都得定义在文件里（譬如类或接口也可以通过类加载器直接生成）。

Class文件是一组以8位字节为基础单位的二进制流，各个数据项严格按照顺序紧凑的排列在Class文件之中，中间没有添加任何分隔符，这使得整个Class文件中存储的内容几乎全部是程序运行的必要数据，没有空隙存在。当遇到需要占用8位字节以上空间的数据项时，则会按照高位在前的方式分割若干个8位字节进行存储。

根据Java虚拟机规范的规定，Class文件格式采用一种类似于C语言结构体的伪结构来存 储数据，这种伪结构中只有两种数据类型：**无符号数和表**。

**无符号数**：属于基本的数据类型，以u1、u2、u4、u8分别来代表1个字节、2个字节、4个字节和8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成字符串值。

**表**：是由多个无符号数或者其他表作为数据项的复合数据数据类型，所有表都习惯性以**"_info"**结尾。表用于描述有层次关系的复合数据类型，整个Class文件本质上就是一张表，它由以下数据项构成。
![Snipaste_2019-04-02_12-19-41.jpg](https://i.loli.net/2019/04/02/5ca2e2e7d80b9.jpg)

## 6.3 Class类文件结构

任何一个Class文件都对应着唯一一个类或接口的定义信息，但反过来说，类或接 口并不一定都得定义在文件里(譬如类或接口也可以通过类加载器直接生成)。

Class文件是一组以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地 排列在Class文件之中，中间没有添加任何分隔符，整个Class文件中存储的内容几乎全部是程序运行的必要数据，没有空隙存在。

当遇到需要占用8位字节以上空间的数据项时，则会按照高位在前（**Big-Endian**）的方式分割成若干个8位字节进行存储。

注：Big-Endian ----具体是指最高位字节在地址最低位、最低位字节在地址最高 位的顺序来存储数据 。

Class文件中只有两种数据类型：**无符号数和表**。

**无符号数**：属于基本的数据类型，，以u1、u2、u4、u8来分别代表1个字节、2个字节、4个 字节和8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8 编码构成字符串值。 

**表**：由多个无符号数或者其他表作为数据项构成的复合数据类型，，所有表都习惯性地 以“_info”结尾。表用于描述有层次关系的复合结构的数据，整个Class文件本质上就是一张 表，它由下表数据项构成
![Snipaste_2019-04-03_20-04-15.jpg](https://i.loli.net/2019/04/03/5ca4a19acf942.jpg)

### 6.3.1 魔数与Class文件版本

**魔数（Magic Number）**：每个Class文件的头4个字节，用来确定这个文件是否为一个能被虚拟机接受的Class文件。（很多文件都用魔数来进行身份识别，使用魔数而不是扩展名来进行身份识别主要基于安全方面的考虑，因为文件扩展名可以随意改动。）

**版本号**：紧跟魔数第5和第6个字节是**次版本号（Minor Version）**，第7第8个字节是**主版本号（Major Version）**。Java的版本号从45开始，JDK 1.1之后的每个JDK大版本发布主版本号向上加1（JDK 1.0～1.1使用了45.0～45.3的 版本号），高版本的JDK能向前兼容以前版本的Class文件，但低版本的JDK不能向后兼容新版本的Class文件。

书中的Java代码示例(书中是以Java1.6编译的)：

```java
package org.fenixsoft.clazz;

public class TestClass {
	
	private int m;
	
	public int inc() {
		return m + 1;
	}
}
```

编译后的Java Class文件：
![Snipaste_2019-04-03_20-36-38.jpg](https://i.loli.net/2019/04/03/5ca4aa1837c8b.jpg)
从图中可以看到，前4个字节的十六进制表示是0xCAFEBABE,代表次版本号的第5个和第6个字节值为 0x0000，而主版本号的值为0x0032，也即是十进制的50，该版本号说明这个文件是可以被 JDK 1.6或以上版本虚拟机执行的Class文件。

:smirk:以下是jdk1.8下编译的Java Class文件
![Snipaste_2019-04-03_20-48-31.jpg](https://i.loli.net/2019/04/03/5ca4abaa93ef5.jpg)

### 6.3.2 常量池

主版本号之后是**常量池**入口，常量池可以理解为Class文件之中的资源仓库，它是Class文件之中与其他项目关联最多的数据类型，也是占用Class文件空间做大的数据项目之一，它也是Class文件中第一个出现的表数据类型项目。

常量池中存放量大类常量：**字面量（Literal）和符号引用（Symbolic Reference）**。

:triangular_flag_on_post:常量池中的每一项常量都是一个表，一共有14种常量类型，表都有一个共同的特点，就是表开始的第一位是一个u1类型的标志位（tag，取值 见表6-3中标志列），代表当前这个常量属于哪种常量类型。所代表的具体 含义见表
![Snipaste_2019-04-03_21-14-30.jpg](https://i.loli.net/2019/04/03/5ca4b1cc4d7f5.jpg)

这14种常量类型各自均有自己的结构，CONSTANT_Class_info的结构
![Snipaste_2019-04-03_21-18-56.jpg](https://i.loli.net/2019/04/03/5ca4b2c9711b4.jpg)

tag是标志位，它用于区分常量类型；name_index是一个索引值，它指 向常量池中一个CONSTANT_Utf8_info类型常量，此常量代表了这个类（或者接口）的全限 定名，这里name_index值（偏移地址：0x0000000B）为0x0002，也即是指向了常量池中的第 二项常量。。继续从图6-3中查找第二项常量，它的标志位（地址：0x0000000D）是0x01，查 表6-3可知确实是一个CONSTANT_Utf8_info类型的常量。CONSTANT_Utf8_info类型的结构见表6-5。
![Snipaste_2019-04-03_21-25-37.jpg](https://i.loli.net/2019/04/03/5ca4b45a1daa0.jpg)

length值说明了这个UTF-8编码的字符串长度是多少字节，它后面紧跟着的长度为length 字节的连续数据是一个使用UTF-8缩略编码表示的字符串。

由于Class文件中方法、字段等都需要引用CONSTANT_Utf8_info型常量来 描述名称，所以CONSTANT_Utf8_info型常量的最大长度也就是Java中方法、字段名的最大长度。而这里的最大长度就是length的最大值，既u2类型能表达的最大值65535。所以Java程 序中如果定义了超过64KB英文字符的变量或方法名，将会无法编译。 

###  6.6.3访问标志
 :dart:常量池之后紧跟的两个字节代表**访问标志（access_flags）**,这个标志用于识别一些类或者接口层次的访问信息，包括：：这个Class是类还是接口；是否定义为public类 型；是否定义为abstract类型；如果是类的话，是否被声明为final等。具体的标志位以及标志 的含义见表
![Snipaste_2019-04-03_21-36-36.jpg](https://i.loli.net/2019/04/03/5ca4b6ed92981.jpg)

